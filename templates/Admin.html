{% extends 'adminnav.html' %}

{% block admin_body %}
<div class="container mt-5">
  <br><div class="topspacer"></div>
    <button class="btn btn-primary" id="add-btn">Add User</button>
    <table class="table table-bordered mt-3" id="user-table">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Name</th>
                <th>Address</th>
                <th>Plate Number</th>
                <th>Room Number</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="user-body">
            <!-- Dynamic content will be inserted here -->
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="user-modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">User Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" name="userid" id="userid">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" class="form-control" name="name" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" name="address" id="address" required>
                    </div>
                    <div class="form-group">
                        <label for="plate_number">Plate Number</label>
                        <input type="text" class="form-control" name="plate_number" id="plate_number">
                    </div>
                    <div class="form-group">
                        <label for="roomNumber">Room Number</label>
                        <input type="text" class="form-control" name="roomNumber" id="roomNumber">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" name="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" name="password" id="password" placeholder="Password or Default()">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function() {
      // Load user data
      function loadUsers() {
          console.log("Loading user data...");
          $.get('/admin/Admin-Dashboard', function(data) {
              console.log("User data loaded successfully:", data);

              if (Array.isArray(data)) {
                  $('#user-body').empty();
                  data.forEach(user => {
                      $('#user-body').append(`
                          <tr>
                              <td>${user.userid}</td>
                              <td>${user.name}</td>
                              <td>${user.address}</td>
                              <td>${user.plate_number}</td>
                              <td>${user.roomNumber}</td>
                              <td>${user.email}</td>
                              <td>
                                  <button class="btn btn-warning edit-btn" data-user='${JSON.stringify(user)}'>Edit</button>
                                  <button class="btn btn-danger delete-btn" data-id='${user.userid}'>Delete</button>
                              </td>
                          </tr>
                      `);
                  });
              } else {
                  console.error('Data is not an array:', data);
                  alert('Unexpected data format received. Please try again.');
              }
          }).fail(function() {
              console.error('Error loading users.');
              alert('Error loading users. Please try again.');
          });
      }

      // Call loadUsers when the page loads
      loadUsers();

      // Add user
      $('#add-btn').click(function() {
          $('#user-modal').modal('show');
          $('#user-form')[0].reset(); // Reset the form for adding a new user
          $('#userid').val(''); // Clear the user ID field
          $('#modalLabel').text('Add User'); // Set modal title
      });

      // Save user
      $('#save-btn').click(function() {
          const data = {
              userid: $('#userid').val(),
              name: $('#name').val(),
              address: $('#address').val(),
              plate_number: $('#plate_number').val(),
              roomNumber: $('#roomNumber').val(),
              email: $('#email').val(),
              password: $('#password').val(),
              action: $('#userid').val() ? 'update' : 'add' // Determine action
          };

          console.log("Saving user data:", data);

          $.ajax({
              type: 'POST',
              url: '/admin/Admin-Dashboard',
              contentType: 'application/json',
              data: JSON.stringify(data),
              success: function(response) {
                  console.log("User saved successfully:", response);
                  $('#user-modal').modal('hide'); // Hide the modal
                  loadUsers(); // Refresh user data
                  alert(response.status);
              },
              error: function() {
                  console.error('Error saving user.');
                  alert('Error saving user. Please try again.');
              }
          });
      });

      // Edit user
      $(document).on('click', '.edit-btn', function() {
          const user = $(this).data('user');
          console.log("Editing user:", user);
          
          // Populate form with user data
          $('#userid').val(user.userid);
          $('#name').val(user.name);
          $('#address').val(user.address);
          $('#plate_number').val(user.plate_number);
          $('#roomNumber').val(user.roomNumber);
          $('#email').val(user.email);
          $('#modalLabel').text('Edit User'); // Set modal title for editing
          $('#user-modal').modal('show'); // Show modal
      });

      // Delete user
      $(document).on('click', '.delete-btn', function() {
          const userId = $(this).data('id');
          if (confirm('Are you sure you want to delete this user?')) {
              $.ajax({
                  type: 'POST',
                  url: '/admin/Admin-Dashboard',
                  contentType: 'application/json',
                  data: JSON.stringify({ userid: userId, action: 'delete' }),
                  success: function(response) {
                      console.log("User deleted successfully:", response);
                      loadUsers(); // Refresh user data
                      alert(response.status);
                  },
                  error: function() {
                      console.error('Error deleting user.');
                      alert('Error deleting user. Please try again.');
                  }
              });
          }
      });
  });
</script>

{% endblock %}
